"use strict";class t{handlers={};dispatch(t,i){this.has(t)&&this.handlers[t].forEach((t=>t(i)))}has(t){return t in this.handlers}on(t,i){this.has(t)?this.handlers[t].add(i):this.handlers[t]=new Set([i])}}class i{data;is_visible=!1;constructor(t=[]){this.data=t}last_timestamp=0;active_index=0;get active_sub(){return this.data[this.active_index]||[0,0,""]}get is_empty(){return 0===this.data.length}display(t=this.is_visible){this.is_visible=t}tick(t){if(!t||this.is_empty)return;const i=t<this.last_timestamp;if(this.last_timestamp=t,i)return void(this.active_index=s(this.data,this.last_timestamp));const[e,a]=this.active_sub;a<t&&(this.active_index+=1)}to_string(){if(!this.is_visible||this.is_empty)return"&nbsp;";const[t,i,s]=this.active_sub;return this.last_timestamp<t||i<this.last_timestamp?"&nbsp;":s}}function s(t,i,e=0,a=t.length-1){if(e>=a)return e;const n=e+Math.floor((a-e)/2),[r,c]=t[n];return r>=i?s(t,i,e,n-1):c<=i?s(t,i,n+1,a):n}class e{display_warn;display_primary;display_secondary;primary_track=new i;secondary_track=new i;captions_disabled=!0;constructor(t,i,s){this.display_warn=t,this.display_primary=i,this.display_secondary=s,this.display=this.display.bind(this),chrome.runtime.onMessage.addListener(this.add_subs.bind(this)),document.addEventListener("click",(t=>{const i=t.target.closest("li");if(!i)return;const s=i.getAttribute("data-uia");s&&s.includes("subtitle-item")&&(this.captions_disabled="subtitle-item-selected-Off"===s||"subtitle-item-Off"===s,!this.captions_disabled||this.primary_track.is_empty||this.secondary_track.is_empty||this.display_warn(""))})),this.init()}init(){this.display_warn("Netflix SUBS: Choose primary captions or disable me")}reset(){this.display_warn(""),this.captions_disabled=!0,this.primary_track=new i,this.secondary_track=new i}display({primary_sub:t,secondary_sub:i}){this.primary_track.display(t?.is_visible),this.secondary_track.display(i?.is_visible)}tick(t){this.primary_track.tick(t),this.display_primary(this.primary_track.to_string()),this.secondary_track.tick(t),this.display_secondary(this.secondary_track.to_string())}add_subs(t){if(!this.captions_disabled||this.primary_track.is_empty||this.secondary_track.is_empty){if(!this.primary_track.is_empty&&this.secondary_track.is_empty)return this.secondary_track=new i(t),void this.display_warn("Netflix SUBS: Secondary captions were added. Now, turn off all captions!");this.primary_track=new i(t),this.secondary_track=new i,this.display_warn("Netflix SUBS: Primary captions were added. Choose secondary ones!")}}}class a extends t{video_el_selector;_video_el;container;warn_caption;primary_caption;secondary_caption;subs;constructor(t){super(),this.video_el_selector=t,this.state_change=this.state_change.bind(this),this.check_video_el=this.check_video_el.bind(this),this.subs=new e(this.display_warn,this.display_primary,this.display_secondary),this.check_video_el()}reset(){this._video_el=null,this.container?.remove(),this.check_video_el(),this.subs.reset()}check_video_el(){this.video_el||setTimeout(this.check_video_el,1e3)}get video_el(){if(!this._video_el){if(!location.href.includes("https://www.netflix.com/watch/"))return null;if(this._video_el=document.querySelector(this.video_el_selector),!this._video_el)return null;this._video_el.ontimeupdate=this.ontimeupdate.bind(this),this.warn_caption=this.create_caption_el("yellow"),this.secondary_caption=this.create_caption_el("#eee"),this.primary_caption=this.create_caption_el("#fff"),this.container=this.create_container([this.warn_caption,this.primary_caption,this.secondary_caption]),document.body.appendChild(this.container),this.subs.init()}return this._video_el}display_warn=t=>{this.warn_caption&&(this.warn_caption.innerHTML=t)};display_primary=t=>{this.primary_caption&&(this.primary_caption.innerHTML=t)};display_secondary=t=>{this.secondary_caption&&(this.secondary_caption.innerHTML=t)};create_container(t){const i=document.createElement("div");return i.style.position="fixed",i.style.bottom="15%",i.style.left="25%",i.style.width="50%",i.style.textAlign="center",i.style.zIndex="",t.forEach((t=>{i.appendChild(t)})),i}create_caption_el(t="#fff"){const i=document.createElement("p");return i.setAttribute("style",`font-size:17px;\n         color:${t};\n         text-shadow:#000000 0px 0px 7px;\n         font-family:Netflix Sans,Helvetica Nueue,Helvetica,Arial,sans-serif;\n         font-weight:bolder`),i}state_change(t){this.subs.display(t)}ontimeupdate(){this.video_el&&(this.subs.tick(this.video_el.currentTime),this.dispatch("timeupdate",{timestamp:this.video_el.currentTime}))}}class n extends t{constructor(){super(),document.addEventListener("keydown",(t=>{(t.ctrlKey||"MetaRight"===t.code||"MetaLeft"===t.code)&&(t.preventDefault(),t.stopImmediatePropagation(),this.dispatch("stepback"))}))}}class r extends t{rewind;step_size=10;last_timestamp=0;begin_timestamp=0;state={video:{timestamp:0},primary_sub:{is_visible:!1},secondary_sub:{is_visible:!1}};constructor(t){super(),this.rewind=t,this.stepback=this.stepback.bind(this),this.timeupdate=this.timeupdate.bind(this),this.stepback_second=this.stepback_second.bind(this)}reset(){this.last_timestamp=0,this.begin_timestamp=0,this.state={video:{timestamp:0},primary_sub:{is_visible:!1},secondary_sub:{is_visible:!1}}}stepback(){this.begin_timestamp>this.state.video.timestamp||(this.last_timestamp<this.state.video.timestamp?this.stepback_first():this.state.primary_sub.is_visible&&this.stepback_second())}stepback_first(){this.update_timestamps(),this.rewind(),this.set_state({video:{timestamp:this.begin_timestamp},primary_sub:{is_visible:!0},secondary_sub:{is_visible:!1}})}stepback_second(){this.update_timestamps(),this.rewind(),this.set_state({video:{timestamp:this.begin_timestamp},primary_sub:{is_visible:!0},secondary_sub:{is_visible:!0}})}update_timestamps(){this.last_timestamp=Math.ceil(this.state.video.timestamp)+1,this.begin_timestamp=Math.floor(this.state.video.timestamp-this.step_size)-1}timeupdate({timestamp:t}){this.state.video.timestamp=t,this.begin_timestamp<=t&&t<=this.last_timestamp||(this.state.primary_sub.is_visible||this.state.secondary_sub.is_visible)&&this.set_state({primary_sub:{is_visible:!1},secondary_sub:{is_visible:!1}})}set_state(t){this.state={...this.state,...t},this.dispatch("state_change",t)}}const c="body video",d=['[aria-label="Seek Back"]','[data-uia="control-back10"]'],h=()=>{for(const t of d){const i=document.querySelector(t);if(i)return i}return null};function o(){const t=new r((()=>{const t=h();t&&t.click()})),i=new a(c);i.on("timeupdate",t.timeupdate),t.on("state_change",i.state_change);(new n).on("stepback",t.stepback),window.addEventListener("popstate",(()=>{i.reset(),t.reset()})),document.head.innerHTML+="<style>.player-timedtext { visibility: hidden; } </style>"}window.addEventListener("load",(()=>{setTimeout(o)}));
